# Pathway Backend

This is the backend for the Pathway application, built with **Payload CMS 3.0** and **Next.js**. It uses **PostgreSQL** as the database.

## Tech Stack
-   **Framework**: [Payload CMS 3.0](https://payloadcms.com) (Next.js App Router)
-   **Database**: PostgreSQL (via `@payloadcms/db-postgres`)
-   **Testing**: Vitest (`pnpm test`)
-   **Package Manager**: pnpm

## Getting Started

1.  **Install dependencies**:
    ```bash
    pnpm install
    ```

2.  **Setup Environment**:
    Copy `.env.example` to `.env` and configure your database URL, Payload secret, and S3 settings (public bucket `S3_BUCKET` + CDN `S3_FILE_URL`, private bucket `S3_PRIVATE_BUCKET`, and `S3_ENDPOINT`/`S3_ACCESS_KEY`/`S3_SECRET_KEY`/`S3_REGION` for MinIO/S3 access).
    ```bash
    cp .env.example .env
    ```

3.  **Run Development Server**:
    ```bash
    pnpm dev
    ```
    The server will start at `http://localhost:3000`.

## API Documentation

The backend provides a REST API automatically generated by Payload CMS, plus custom endpoints.

### 1. Authentication & Users
-   **Register**: `POST /api/users`
    -   Public access. Default role is `subscriber`.
-   **Login**: `POST /api/users/login`
-   **Logout**: `POST /api/users/logout`
-   **Me**: `GET /api/users/me`
    -   Returns current user object.
-   **Reset Password**: `POST /api/users/forgot-password` / `POST /api/users/reset-password`
-   **Manage Users** (Admin Only):
    -   `GET /api/users` (List)
    -   `PATCH /api/users/:id` (Update)
    -   `DELETE /api/users/:id` (Delete)

### 2. Booking System
-   **Check Availability**: `GET /api/availability`
    -   Query: `?coach=:id&from=YYYY-MM-DD&to=YYYY-MM-DD`
    -   Public access.
-   **Book Session**: `POST /api/coaching-sessions`
    -   Public access (can book anonymously).
    -   Body: `{ "expert": "...", "scheduledAt": "...", "bookerEmail": "..." }`
-   **Manage Sessions**:
    -   `GET /api/coaching-sessions` (Own sessions or Coach's sessions)
    -   `PATCH /api/coaching-sessions/:id` (Coach/Admin: Confirm/Cancel)
    -   `DELETE /api/coaching-sessions/:id` (Admin only)

### 3. Learning Management (LMS)

#### Courses (Public Discovery)
-   `GET /api/courses`: Public. Returns published courses for discovery.
-   `GET /api/courses/:id`: Public. Course metadata.
-   `POST/PATCH/DELETE`: Coach/Admin only.

#### Enrollments
-   `POST /api/enrollments`: Authenticated users can enroll themselves.
-   `GET /api/enrollments`: Returns own enrollments only.
-   `PATCH /api/enrollments/:id`: Admin/Coach (update status/progress).

#### Modules & Lessons
-   `GET /api/modules`: **Requires authentication**. Returns published modules.
-   `GET /api/lessons`: **Requires authentication**. Returns published/free lessons.
-   `POST/PATCH/DELETE`: Coach/Admin only.

#### LMS Content Delivery (Enrollment Required)
These custom endpoints verify course enrollment before returning content:

-   **`GET /api/lessons/:id/content`**
    -   Requires: Authentication + Active Enrollment
    -   Returns: Full lesson content (videos, text, resources)
    -   Error: `403 Enrollment required` if not enrolled

-   **`GET /api/quizzes/:id/take`**
    -   Requires: Authentication + Active Enrollment
    -   Returns: Quiz questions with **answers stripped**
    -   Error: `403 Enrollment required` if not enrolled

#### Quizzes (Staff Only Direct Access)
-   `GET /api/quizzes`: **Coach/Admin only** (contains answers).
-   Learners must use `/api/quizzes/:id/take` endpoint.

#### Progress & Quiz Attempts
-   `GET /api/progress`: Returns own progress records (via enrollment).
-   `POST /api/progress`: Create progress record (must be enrolled).
-   `PATCH /api/progress/:id`: Update own progress.
-   `GET /api/quiz-attempts`: Returns own quiz attempts.
-   `POST /api/quiz-attempts`: Submit quiz attempt (must be enrolled).

### 4. Content (CMS) & Media

#### Posts
-   `GET /api/posts`: Public. Returns published posts.
    -   **Access Levels**:
        -   `public`: Full content for everyone
        -   `subscribers`: Anonymous users see only `title`, `excerpt`, `featuredImage`. Full `content` requires authentication.
-   `POST/PATCH/DELETE`: Admin/Coach/Creator only.

#### Pages
-   `GET /api/pages`: Public (published only).
-   `POST/PATCH/DELETE`: Admin/Coach/Creator only.

#### Media
-   `GET /api/media/:id`: Public file access.
-   `GET /api/media-private/:id`: Staff only (protected assets).
-   `POST /api/media`: Authenticated users (upload).
-   `DELETE /api/media/:id`: Admin only.

### 5. Global Settings
(If configured as Globals)
-   `GET /api/globals/settings`

## Testing

Run the API test suite to verify endpoints:
```bash
pnpm test:api
```

## Access Control

For detailed access control documentation including role hierarchy, field-level security, and business logic constraints, see [ACCESS_CONTROL.md](./ACCESS_CONTROL.md).

**Key Points:**
- Default user role is `subscriber` (set at registration)
- Roles: `admin`, `coach`, `creator`, `subscriber`
- LMS content delivery requires enrollment verification
- Quiz answers are protected at the API level
- All access rules are backend-enforced

## Docker

You can use the provided `docker-compose.yml` to spin up the application or a local database.

```bash
docker-compose up -d
```
