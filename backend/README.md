# Pathway Backend

This is the backend for the Pathway application, built with **Payload CMS 3.0** and **Next.js**. It uses **PostgreSQL** as the database.

## Tech Stack
-   **Framework**: [Payload CMS 3.0](https://payloadcms.com) (Next.js App Router)
-   **Database**: PostgreSQL (via `@payloadcms/db-postgres`)
-   **Testing**: Vitest (`pnpm test`)
-   **Package Manager**: pnpm

## Getting Started

1.  **Install dependencies**:
    ```bash
    pnpm install
    ```

2.  **Setup Environment**:
    Copy `.env.example` to `.env` and configure your database URL, Payload secret, and S3 settings (public bucket `S3_BUCKET` + CDN `S3_FILE_URL`, private bucket `S3_PRIVATE_BUCKET`, and `S3_ENDPOINT`/`S3_ACCESS_KEY`/`S3_SECRET_KEY`/`S3_REGION` for MinIO/S3 access).
    ```bash
    cp .env.example .env
    ```

3.  **Run Development Server**:
    ```bash
    pnpm dev
    ```
    The server will start at `http://localhost:3000`.

## API Documentation

The backend provides a REST API automatically generated by Payload CMS, plus custom endpoints.

### 1. Authentication & Users
-   **Register**: `POST /api/users`
    -   Public access. Default role is `subscriber`.
-   **Login**: `POST /api/users/login`
-   **Logout**: `POST /api/users/logout`
-   **Me**: `GET /api/users/me`
    -   Returns current user object.
-   **Reset Password**: `POST /api/users/forgot-password` / `POST /api/users/reset-password`
-   **Manage Users** (Admin Only):
    -   `GET /api/users` (List)
    -   `PATCH /api/users/:id` (Update)
    -   `DELETE /api/users/:id` (Delete)

### 2. Booking System
-   **Check Availability**: `GET /api/availability`
    -   Query: `?coach=:id&from=YYYY-MM-DD&to=YYYY-MM-DD`
    -   Public access.
-   **Book Session**: `POST /api/coaching-sessions`
    -   Public access (can book anonymously).
    -   Body: `{ "expert": "...", "scheduledAt": "...", "bookerEmail": "..." }`
-   **Manage Sessions**:
    -   `GET /api/coaching-sessions` (Own sessions or Coach's sessions)
    -   `PATCH /api/coaching-sessions/:id` (Coach/Admin: Confirm/Cancel)
    -   `DELETE /api/coaching-sessions/:id` (Admin only)

### 3. Learning Management (LMS)
-   **Courses**:
    -   `GET /api/courses`: Public (published only).
    -   `POST/PATCH/DELETE`: Admin/Coach only.
-   **Enrollments**:
    -   `POST /api/enrollments`: Authenticated users can enroll.
    -   `GET /api/enrollments`: Own enrollments only.
    -   `PATCH /api/enrollments/:id`: Admin/Coach (update status/progress).
-   **Modules / Lessons**:
    -   `GET /api/modules`, `GET /api/lessons`: Public (if course is public).

### 4. Content (CMS) & Media
-   **Posts / Pages**:
    -   `GET /api/posts`: Public.
    -   `POST/PATCH/DELETE`: Admin/Coach/Creator only.
-   **Media**:
    -   `GET /api/media/:id`: Public file access.
    -   `POST /api/media`: Authenticated users (upload).
    -   `DELETE /api/media/:id`: Admin only.

### 5. Global Settings
(If configured as Globals)
-   `GET /api/globals/settings`

## Testing

Run the API test suite to verify endpoints:
```bash
pnpm test:api
```

## Docker

You can use the provided `docker-compose.yml` to spin up the application or a local database.

```bash
docker-compose up -d
```
